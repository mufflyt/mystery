<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gathering Drive Time Isochrones • tyler</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Gathering Drive Time Isochrones">
<meta property="og:description" content="A wrapper on the amazing hereR package to get drive time isochrones.
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tyler</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/create_isochrones.html">Gathering Drive Time Isochrones</a>
    </li>
    <li>
      <a href="../articles/geocode.html">Geocoding</a>
    </li>
    <li>
      <a href="../articles/get_census_data.html">Getting Data from the US Census Bureau for Isochrones</a>
    </li>
    <li>
      <a href="../articles/my-vignette.html">Searching the NPI Database Starting with Taxonomy Codes</a>
    </li>
    <li>
      <a href="../articles/search_and_process_npi.html">Search and Process NPI Numbers</a>
    </li>
    <li>
      <a href="../articles/validate_and_remove_invalid_npi.html">Gather Physician Data Starting With NPI Numbers</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Gathering Drive Time Isochrones</h1>
                        <h4 data-toc-skip class="author">Tyler Muffly,
MD</h4>
            
      

      <div class="hidden name"><code>create_isochrones.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The <code>create_isochrones_for_dataframe</code> function is a
powerful tool that allows you to calculate isochrones for a given
location using the <code>hereR</code> package. Isochrones represent
areas that can be reached from a specific point within a certain travel
time or distance. These visual representations are valuable for various
applications, such as location analysis, logistics, and transportation
planning. In this guide, we will walk you through how to use the
<code>create_isochrones</code> function.</p>
</div>
<div class="section level2">
<h2 id="geodesic-versus-drive-time-for-patient-travel">Geodesic versus Drive-Time for Patient Travel<a class="anchor" aria-label="anchor" href="#geodesic-versus-drive-time-for-patient-travel"></a>
</h2>
<p>The methods for calculating patient travel distance to hospitals can
vary significantly. This paper aims to provide an overview of different
methods and their characteristics. The primary factor influencing travel
distance calculations is the choice of distance measure, specifically,
whether it’s driving distance or straight-line distance. This
distinction has a significant impact on the results.</p>
<div class="section level4">
<h4 id="straight-line-distance">Straight-Line Distance<a class="anchor" aria-label="anchor" href="#straight-line-distance"></a>
</h4>
<p>A common practice in AHRQ is to calculate the shortest or
“straight-line” distance (geodetic or great circle distance) between the
patient location and the point of care (e.g., hospital or emergency
department). This method is favored because it can be easily computed
using statistical software like SAS®.</p>
<ul>
<li>
<strong>Agency for Healthcare Research and Quality (AHRQ):</strong>
AHRQ employs an equation to convert straight-line distance to drive
time. The equation includes various parameters like baseline distance,
census division dummy variables, urban/rural location dummy variables,
and error terms. AHRQ utilizes the <code>ggmap</code> package to geocode
the addresses of hospitals. AHRQ also considers an alternative metric,
which is the driving distance or driving times. These can be obtained
from various mapping software such as Google Maps, MapQuest,
OpenStreetMaps, and ArcGIS Network Analyst. AHRQ uses the patient
location as the geographic centroid of the patient’s zip code. (<a href="https://hcup-us.ahrq.gov/reports/methods/MS2021-02-Distance-to-Hospital.jsp" class="external-link uri">https://hcup-us.ahrq.gov/reports/methods/MS2021-02-Distance-to-Hospital.jsp</a>)</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="st">`</span><span class="at">Di=αBi+Ciβ+ LiΥ + εi</span><span class="st">`</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  Where<span class="sc">:</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="sc">-</span> i indexes patients</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="sc">-</span> Di <span class="sc">:</span> driving distance</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="sc">-</span> Bi <span class="sc">:</span> baseline distance</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="sc">-</span> Ci <span class="sc">:</span> vector of census division dummy variables</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="sc">-</span> Li <span class="sc">:</span> vector of urban<span class="sc">/</span>rural location dummy variables</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="sc">-</span> α <span class="sc">:</span> coefficient <span class="cf">for</span> baseline distance</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="sc">-</span> β <span class="sc">:</span> vector of coefficients <span class="cf">for</span> census division dummy variables</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="sc">-</span> Υ <span class="sc">:</span> vector of coefficients <span class="cf">for</span> urban<span class="sc">/</span>rural location dummy variables</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="sc">-</span> εi <span class="sc">:</span> mean<span class="sc">-</span>zero error term</span></code></pre></div>
<ul>
<li><p><strong>March of Dimes Maternity Care Deserts:</strong> This
organization also uses drive time as a metric for calculating travel
distance. <a href="https://github.com/mufflyt/tyler/files/13433413/MaternityCareDesertsReport-TechnicalNotes.pdf" class="external-link">Reference</a></p></li>
<li><p><strong>ESRI Methodology:</strong> ESRI has its methodology for
creating drive-time areas, with certain limitations on travel times and
distances. <a href="https://doc.arcgis.com/en/arcgis-online/analyze/create-drive-time-areas.htm" class="external-link">Reference</a>.
Limitations:</p></li>
<li><p>“You must be granted the network analysis privilege to use Create
Drive-Time Areas.”,</p></li>
<li><p>“Travel times cannot exceed 9 hours (540 minutes) when walking or
5 hours (300 minutes) for all other travel times.”, * “Travel distances
cannot exceed 27 miles (43.45 kilometers) when walking or 300 miles
(482.8 kilometers) for all other travel distances.”</p></li>
<li><p><strong>Veteran’s Administration:</strong> The Veteran’s
Administration utilizes drive time in its calculations. <a href="https://www.federalregister.gov/documents/2020/07/15/2020-14341/update-to-access-standards-drive-time-calculations" class="external-link">Reference</a></p></li>
<li><p><strong>Department of Transportation:</strong> The Department of
Transportation provides tools for distance calculations. <a href="https://www.transportation.gov/priorities/equity/justice40/etc-explorer" class="external-link">Reference</a></p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="potential-references-comparing-drive-time-vs--geodesic">Potential References comparing Drive Time vs. Geodesic<a class="anchor" aria-label="anchor" href="#potential-references-comparing-drive-time-vs--geodesic"></a>
</h2>
<ul>
<li><p>Lidsky ME, Sun Z, Nussbaum DP, Adam MA, Speicher PJ, Blazer DG.
“Going the extra mile: improved survival for pancreatic cancer patients
traveling to high-volume centers.” Annals of Surgery.
2017;266(2):333–8.</p></li>
<li><p>Bliss RL, Katz JN, Wright EA, Losina E. “Estimating proximity to
care: are straight line and zipcode centroid distances acceptable
measures?” Medical Care. 2012;50(1):99–106.</p></li>
<li><ul>
<li><a href="https://github.com/mufflyt/tyler/files/13433577/isprs-archives-XLVIII-4-W7-2023-53-2023.pdf" class="external-link">isprs-archives-XLVIII-4-W7-2023-53-2023.pdf</a></li>
</ul></li>
</ul>
<p>This comprehensive overview highlights the diversity in methods used
to calculate patient travel distance to hospitals and the potential
impact on healthcare outcomes.</p>
<div class="section level3">
<h3 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h3>
<p>Before you start using the <code>create_isochrones</code> function,
make sure you have completed the following steps:</p>
<ol style="list-style-type: decimal">
<li><p><strong>HERE API Key</strong>: You need to have a HERE API key.
If you don’t have one, you can obtain it from the HERE Developer
Portal.</p></li>
<li><p><strong>Environment Variable</strong>: Set your HERE API key as
an environment variable named <code>HERE_API_KEY</code>. This is
essential for secure access to HERE services.</p></li>
<li><p><strong>Load the <code>tyler</code> package</strong>: Ensure that
you load the <code>tyler</code> package, which contains the
<code>create_isochrones</code> function.</p></li>
</ol>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mufflyt.github.io/tyler/" class="external-link">tyler</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h3>
<p>Now that you have the prerequisites in place, let’s explore how to
use the <code>create_isochrones_for_dataframe</code> function. We use
the HERE API to calculate optimal routes and directions for various
modes of transportation, including driving, walking, cycling, and public
transit. It provides detailed turn-by-turn instructions, estimated
travel times, and route alternatives. This is simpler than using an OSRM
server running the AWS cloud, and the cost is minimal.</p>
<div class="section level4">
<h4 id="input-parameters">Input Parameters<a class="anchor" aria-label="anchor" href="#input-parameters"></a>
</h4>
<p>The <code>create_isochrones</code> function accepts the following
parameters: * <code>location</code>: An <code>sf</code> object
representing the location for which isolines will be calculated. Need
separate <code>lat</code> and <code>long</code> columns.<br>
* <code>range</code>: A numeric vector of time ranges in seconds. These
time ranges determine the extent of the isolines. *
<code>posix_time</code>: A <code>POSIXct</code> object representing the
date and time of calculation. The default is set to “2023-10-20
08:00:00”. We chose this date because it is during Influenza season when
most people see their physicians for a first appointment of the day at
0800.</p>
<p>You may need to split the geometry column into separate
<code>lat</code> and <code>long</code> columns using this code:</p>
<pre><code><span><span class="va">geocoded_data1</span> <span class="op">&lt;-</span> <span class="va">geocoded_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lat <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">[</span>, <span class="st">"Y"</span><span class="op">]</span>,</span>
<span>               long <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">[</span>, <span class="st">"X"</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span><span class="va">geocoded_data1</span>, <span class="st">"/NPPES_November_filtered_data_for_geocoding_geocoded_addresses_not_sf.csv"</span><span class="op">)</span></span></code></pre>
<p>We do a join between the postmastr file
<code>postmastr_clinician_data.csv</code> and the geocoded results file
<code>geocoded_data_to_match_house_number</code>. This is because the
HERE API does not allow you to pass a master ID number into the API and
all the data is washed out during geocoding. The <code>postmastr</code>
package allows you to parse the addresses on the
<code>clinician_data</code> so that we can match the addresses together
based on: state, house number, and zip code.</p>
<p>This was all done in exploratory.io and then read back into
<code>Gathering data.R</code>.</p>
<pre><code><span><span class="fu">inner_join</span><span class="op">(</span><span class="va">`geocoded_data_to_match_house_number`</span>, by <span class="op">=</span> <span class="fu">join_by</span><span class="op">(</span></span>
<span>  <span class="va">`postmastr.pm.state`</span> <span class="op">==</span> <span class="va">`here.state_code`</span>, </span>
<span>  <span class="va">`postmastr.pm.zip`</span> <span class="op">==</span> <span class="va">`here.postal_code`</span>, </span>
<span>  <span class="va">`postmastr.pm.house`</span> <span class="op">==</span> <span class="va">`here.house_number`</span><span class="op">)</span><span class="op">)</span></span></code></pre>
<pre><code><span><span class="va">inner_join_postmastr_clinician_data</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"data/inner_join_postmastr_clinician_data.csv"</span><span class="op">)</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">st_as_sf</span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"long"</span>, <span class="st">"lat"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">location</span><span class="op">)</span></span>
<span>  </span>
<span><span class="fu">create_isochrones_for_dataframe</span><span class="op">(</span><span class="va">inner_join_postmastr_clinician_data_sf</span>, range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span><span class="op">*</span><span class="fl">60</span>, <span class="fl">60</span><span class="op">*</span><span class="fl">60</span>, <span class="fl">120</span><span class="op">*</span><span class="fl">60</span>, <span class="fl">180</span><span class="op">*</span><span class="fl">60</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h4>
<p>I added in the code needed to read in RDS, xlsx, xls, and csv files.
It can also read in sf files. They needed to have a column called
‘location’ and another called <code>geometry</code>. Here’s an example
of how to use the <code>create_isochrones_for_dataframe</code>
function:</p>
<pre><code>input_file &lt;- "data/inner_join_postmastr_clinician_data.csv"
isochrones_data &lt;- create_isochrones_for_dataframe(input_file, breaks = c(30*60, 60*60, 120*60, 180*60))

&gt; isochrones_data
[1] 1
splay setup instructions:
To create isochrones for a specific point(s) use the following code:
tryLocationMemo(location = location, range = c(1800, 3600, 7200, 10800))
Setting up the hereR access...
Sending 1 request(s) with unlimited RPS to: 'https://isoline.router.hereapi.com/v8/isolines?...'
Received 1 response(s) with total size: 2.8 Kb
Isoline successfully produced for range: 1800 seconds
Sending 1 request(s) with unlimited RPS to: 'https://isoline.router.hereapi.com/v8/isolines?...'
Received 1 response(s) with total size: 3.1 Kb
Isoline successfully produced for range: 3600 seconds
Sending 1 request(s) with unlimited RPS to: 'https://isoline.router.hereapi.com/v8/isolines?...'
Received 1 response(s) with total size: 4.8 Kb
Isoline successfully produced for range: 7200 seconds
Sending 1 request(s) with unlimited RPS to: 'https://isoline.router.hereapi.com/v8/isolines?...'
Received 1 response(s) with total size: 6.9 Kb
Isoline successfully produced for range: 10800 seconds</code></pre>
</div>
<div class="section level4">
<h4 id="output">Output<a class="anchor" aria-label="anchor" href="#output"></a>
</h4>
<p>The function returns a list of isolines for different time ranges.
Each isoline is represented as an <code>sf</code> object, making it easy
to visualize and analyze. The <code>create_isochrones</code> function is
wrapped with <code>memoise</code> so it does a nice job caching the
data. Of note, none of the columns that you feed into the function will
come out the other side after going to the HERE API. Therefore, we are
hoping there is a 1:1 relationship in rows to isochrones. If not we may
need to mark each column with a different time that we feed to the HERE
API as a pseudo-identifier.</p>
</div>
</div>
<div class="section level3">
<h3 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h3>
<p>The <code>create_isochrones</code> function simplifies the process of
calculating isolines for location-based analysis. Whether you’re
exploring accessibility, optimizing routes, or conducting spatial
analysis, isochrones provide valuable insights into travel times and
distances. With the <code>tyler</code> package and the
<code>create_isochrones</code> function, you can streamline your
location-based workflows and make informed decisions.</p>
</div>
</div>
<div class="section level2">
<h2 id="features-and-bugs">Features and bugs<a class="anchor" aria-label="anchor" href="#features-and-bugs"></a>
</h2>
<p>If you have ideas for other features that would make name handling
easier, or find a bug, the best approach is to either report it or add
it!</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Tyler Muffly.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
